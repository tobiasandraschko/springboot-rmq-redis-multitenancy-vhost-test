<!DOCTYPE html>
<html>
<head>
    <title>Multi-tenant WebSocket Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .message-box {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 10px;
            height: 200px;
            overflow-y: auto;
        }
        .controls {
            margin: 10px;
            padding: 10px;
            border: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="connect('tenant1')">Connect Tenant 1</button>
        <button onclick="connect('tenant2')">Connect Tenant 2</button>
    </div>

    <div>
        <h3>Tenant 1</h3>
        <div id="tenant1-messages" class="message-box"></div>
    </div>

    <div>
        <h3>Tenant 2</h3>
        <div id="tenant2-messages" class="message-box"></div>
    </div>

    <script>
        const tenantStomps = {};
        const messageInterval = {};
        const messageCounters = {};

        function connect(tenant) {
            if (!messageCounters[tenant]) {
                messageCounters[tenant] = 1;
            }

            const userId = `user_${Math.random().toString(36).substring(2, 9)}`;
            const socket = new SockJS('http://localhost:8085/ws');
            const stomp = Stomp.over(socket);
            
            stomp.connect(
                { 'Authorization': `Bearer ${tenant}` },
                frame => {
                    console.log(`Connected: ${frame}`);
                    tenantStomps[tenant] = { stomp, userId };
                    
                    // Subscribe to messages
                    stomp.subscribe('/topic/messages', function(response) {
                        const messages = JSON.parse(response.body);
                        messages.forEach(message => {
                            appendMessage(tenant, `Received: ${message.content} (Acknowledged: ${message.acknowledged})`);
                        });
                    });

                    startSendingMessages(tenant);
                },
                error => {
                    console.error('Connection error:', error);
                    appendMessage(tenant, `Connection error: ${error}`);
                }
            );
        }

        function startSendingMessages(tenant) {
            // Clear existing interval if any
            if (messageInterval[tenant]) {
                clearInterval(messageInterval[tenant]);
            }

            messageInterval[tenant] = setInterval(() => {
                const connection = tenantStomps[tenant];
                if (connection && connection.stomp) {
                    const message = {
                        content: `Message #${messageCounters[tenant]} from ${tenant} at ${new Date().toLocaleString()}`,
                        tenant: tenant,
                        userId: connection.userId
                    };
                    
                    connection.stomp.send("/app/send", {}, JSON.stringify(message));
                    appendMessage(tenant, `Sent: ${message.content}`);
                    messageCounters[tenant]++;
                }
            }, 5000);
        }

        function appendMessage(tenant, message) {
            const messageBox = document.getElementById(`${tenant}-messages`);
            const messageElement = document.createElement('div');
            messageElement.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            messageBox.appendChild(messageElement);
            messageBox.scrollTop = messageBox.scrollHeight;
        }
    </script>
</body>
</html>